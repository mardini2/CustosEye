name: build-windows-exe

on:
  push:
    branches: ['**']
    tags: ['v*.*.*']
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          if (Test-Path requirements.txt) { python -m pip install -r requirements.txt }
          python -m pip install -e .
          python -m pip install black ruff mypy pytest pyinstaller waitress pystray pillow

      - name: Lint, typecheck, test
        shell: pwsh
        run: |
          python -m black --check app agent algorithm dashboard tests
          python -m ruff check app agent algorithm dashboard tests
          python -m mypy app agent algorithm dashboard
          python -m pytest -q

      - name: Build EXE with icon and bundle assets
        shell: pwsh
        run: |
          # Icon lives under dashboard/static/assets
          $IconPath = "dashboard\static\assets\favicon.ico"
          $iconArgs = @()
          if (Test-Path $IconPath) { $iconArgs = @('--icon', $IconPath) }

          # Include config/data and Flask static/templates
          pyinstaller --noconfirm --onefile --name CustosEye.exe --console `
            $iconArgs `
            --add-data "data;data" `
            --add-data "dashboard\static;dashboard\static" `
            --add-data "dashboard\templates;dashboard\templates" `
            app/console.py

          New-Item -ItemType Directory -Force -Path dist | Out-Null

          if ($env:GITHUB_REF -like 'refs/tags/*') {
            $version = $env:GITHUB_REF_NAME
          } else {
            $version = "dev-" + $env:GITHUB_SHA.Substring(0,7)
          }
          "$version`n$env:GITHUB_SHA" | Out-File -Encoding ascii dist\VERSION.txt

          Get-ChildItem dist

      - name: Compute EXE SHA256 and stage suppress file
        shell: pwsh
        run: |
          $exePath = "dist/CustosEye.exe"
          if (!(Test-Path $exePath)) {
            Write-Error "EXE not found at $exePath"
            exit 1
          }
          $hash = (Get-FileHash $exePath -Algorithm SHA256).Hash
          Write-Host "EXE SHA256: $hash"
          # Save the hash alongside the build
          $hash | Out-File -Encoding ascii dist\CUSTOSEYE_SHA256.txt

          if (Test-Path "data\self_suppress.json") {
            New-Item -ItemType Directory -Force release\data | Out-Null
            $content = Get-Content data\self_suppress.json -Raw
            $updated = $content -replace '(?<="sha256":\s*\[)[^\]]*', "`n    `"$hash`"`n  "
            $updated | Out-File -Encoding utf8 release\data\self_suppress.json
          }

      - name: Create release ZIP
        shell: pwsh
        run: |
          # ensure release folders exist
          New-Item -ItemType Directory -Force release | Out-Null
          New-Item -ItemType Directory -Force release\data | Out-Null
          New-Item -ItemType Directory -Force release\assets | Out-Null

          # ship a clean default: no pre-watched files
          Set-Content -Encoding ascii data\integrity_targets.json "[]"

          # binaries + meta
          if (Test-Path dist\CustosEye.exe) { Copy-Item dist\CustosEye.exe release\ }
          if (Test-Path dist\VERSION.txt)   { Copy-Item dist\VERSION.txt   release\ }
          if (Test-Path dist\CUSTOSEYE_SHA256.txt) { Copy-Item dist\CUSTOSEYE_SHA256.txt release\ }
          if (Test-Path README_howto.md) { Copy-Item README_howto.md -Destination release\README.md -Force }

          # configs
          if (Test-Path data\rules.json)         { Copy-Item data\rules.json          -Destination release\data\ -Force }
          if (Test-Path data\csc_weights.json)   { Copy-Item data\csc_weights.json    -Destination release\data\ -Force }
          # copy the just-forced-empty targets file
          Copy-Item data\integrity_targets.json  -Destination release\data\ -Force

          # optional self-suppress list if present (lets you hide our own EXE/process hash)
          if (Test-Path data\self_suppress.json) { Copy-Item data\self_suppress.json  -Destination release\data\ -Force }

          # assets (icon) from Flask static path
          if (Test-Path dashboard\static\assets\favicon.ico) {
            Copy-Item dashboard\static\assets\favicon.ico -Destination release\assets\ -Force
          }

          # zip it up
          Compress-Archive -Path release\* -DestinationPath CustosEye-Windows.zip -Force
          Get-ChildItem CustosEye-Windows.zip

      - name: Upload EXE artifact
        uses: actions/upload-artifact@v4
        with:
          name: CustosEye-exe
          path: |
            dist/CustosEye.exe
            dist/VERSION.txt
            dist/CUSTOSEYE_SHA256.txt
          if-no-files-found: error

      - name: Upload ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: CustosEye-zip
          path: CustosEye-Windows.zip
          if-no-files-found: error

      - name: Create GitHub Release (tag push only)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: CustosEye-Windows.zip
          generate_release_notes: true